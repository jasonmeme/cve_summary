import { useEffect, useState } from 'react';
import Head from 'next/head';
import $ from 'jquery';
import 'datatables.net';
import 'datatables.net-bs5';
import 'bootstrap/dist/css/bootstrap.min.css';

export default function Home({ cveData }) {
  const [isLoading, setIsLoading] = useState(true);

  useEffect(() => {
    if (typeof window !== 'undefined') {
      $('#datatable').DataTable({
        data: cveData,
        columns: [
          { data: 'year' },
          { data: 'CVE_Name' },
          { data: 'Product' },
          { data: 'Version' },
          { data: 'Vulnerability' },
          { data: 'CVE_description' },
          { 
            data: 'CVE_github',
            render: function(data) {
              return data ? data : 'N/A';
            }
          },
          { 
            data: 'CVE_references',
            render: function(data) {
              return data ? data : 'N/A';
            }
          }
        ],
        order: [[0, 'desc'], [1, 'desc']],
        pageLength: 25,
        responsive: true,
      });
      setIsLoading(false);
    }
  }, [cveData]);

  return (
    <div className="container">
      <Head>
        <title>CVE Search</title>
      </Head>

      {isLoading && (
        <div id="overlay">
          <div className="spinner"></div>
          <br />
          Loading... (usually 5-10s)
        </div>
      )}

      <h2 className="my-4">CVE Search</h2>

      <table id="datatable" className="table table-striped table-bordered" style={{ width: '100%' }}>
        <thead>
          <tr>
            <th>Year</th>
            <th>CVE Name</th>
            <th>Product</th>
            <th>Version</th>
            <th>Vulnerability</th>
            <th>Description</th>
            <th>GitHub</th>
            <th>References</th>
          </tr>
        </thead>
      </table>

      <footer className="mt-4 text-muted">
        <p>Searchable CVEs from <a href="https://github.com/trickest/cve">https://github.com/trickest/cve</a>, by <a href="https://twitter.com/andrewmohawk">@AndrewMohawk</a>.</p>
      </footer>

      <style jsx>{`
        #overlay {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(255, 255, 255, 0.8);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 1000;
        }
        .spinner {
          border: 5px solid #f3f3f3;
          border-top: 5px solid #3498db;
          border-radius: 50%;
          width: 50px;
          height: 50px;
          animation: spin 1s linear infinite;
        }
        @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }
      `}</style>
    </div>
  );
}

export async function getStaticProps() {
  const cveData = require('../public/CVE_list.json');
  return {
    props: {
      cveData,
    },
    // Revalidate once per day
    revalidate: 86400,
  };
}